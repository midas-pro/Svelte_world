<Editor :user :article on:publish='update(event.article)' :inProgress/>

<script>
	import { goto } from 'sapper/runtime.js';
	import Editor from './_EditorPage.html';
	import * as api from '../_api.js';
	import { user } from '../_auth.js';

	export default {
		components: {
			Editor
		},

		preload({ session, params }) {
			return api.get(`articles/${params.slug}`).then(({ article }) => {
				return {
					article,
					user: session ? session.user : user
				};
			});
		},

		data() {
			return {
				inProgress: false
			};
		},

		methods: {
			update(article) {
				const { params, user } = this.get();

				this.set({ inProgress: true });

				api.put(`articles/${params.slug}`, { article }, user && user.token).then(response => {
					if (response.article) {
						goto(`/article/${response.article.slug}`);
					}
				});
			}
		}
	};
</script>